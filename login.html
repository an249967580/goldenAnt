<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>验证码登录 · 金蚂蚁</title>
    <meta name="description" content="使用邮箱或手机号验证码快速登录掼蛋科技账户。" />
    <link rel="stylesheet" href="./dist/output.css" />
    <script src="https://unpkg.com/lucide@0.452.0/dist/umd/lucide.min.js"></script>
</head>

<body
    class="min-h-screen bg-gradient-to-br from-slate-50 to-white text-slate-900 dark:from-slate-950 dark:to-slate-900 dark:text-slate-100">
    <header class="border-b bg-white/70 dark:bg-slate-950/50 backdrop-blur">
        <nav class="mx-auto max-w-6xl px-4">
            <div class="flex h-16 items-center justify-between">
                <a href="/index.html" class="flex items-center gap-2">
                    <img src="assets/logo.png" alt="掼蛋科技 Logo" class="h-8 w-8 rounded-xl" />
                    <div class="font-bold tracking-tight">金蚂蚁</div>
                </a>
            </div>
        </nav>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-10 grid lg:grid-cols-2 gap-10 items-center">
        <!-- 左侧介绍 -->
        <section class="hidden lg:block">
            <div class="rounded-3xl border p-8 bg-white/60 dark:bg-slate-900/40">
                <div
                    class="inline-flex items-center gap-2 border rounded-full px-3 py-1 text-sm text-slate-600 dark:text-slate-300">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> 公平竞技 · 实时反作弊
                </div>
                <h1 class="mt-4 text-3xl font-bold leading-tight">
                    验证码登录，<span
                        class="bg-gradient-to-r from-emerald-400 to-blue-500 bg-clip-text text-transparent">更快捷更安全</span>
                </h1>
                <ul class="mt-6 space-y-3 text-slate-600 dark:text-slate-300">
                    <li>✅ 支持邮箱或手机号登录</li>
                    <li>✅ 云端同步战绩与称号</li>
                    <li>✅ 无需密码，输入验证码即可登录</li>
                </ul>
            </div>
        </section>

        <!-- 登录卡片 -->
        <section>
            <div
                class="mx-auto max-w-md rounded-3xl border bg-white/80 dark:bg-slate-900/60 backdrop-blur p-8 shadow-card">
                <div class="flex items-center gap-2 mb-4">
                    <img src="assets/logo.png" alt="掼蛋科技 Logo" class="h-8 w-8 rounded-xl" />
                    <h2 class="text-xl font-semibold">验证码登录</h2>
                </div>

                <!-- 选项卡 -->
                <div class="mb-4">
                    <div id="login-tabs" class="grid grid-cols-2 rounded-xl border overflow-hidden">
                        <button id="tab-phone" type="button" class="py-2 font-medium transition-colors"
                            aria-selected="true">
                            手机号登录
                        </button>
                        <button id="tab-email" type="button" class="py-2 font-medium transition-colors"
                            aria-selected="false">
                            邮箱登录
                        </button>
                    </div>
                </div>

                <!-- 邀请码 -->
                <div id="invite-box"
                    class="hidden mb-4 p-3 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm">
                </div>

                <!-- 手机登录 -->
                <form id="form-phone" class="space-y-4">
                    <div>
                        <label class="block text-sm mb-1">手机号</label>
                        <input type="tel" name="phone" placeholder="请输入手机号" class="w-full rounded-xl border px-3 py-2"
                            required>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" name="code" maxlength="6" inputmode="numeric" placeholder="输入验证码"
                            class="w-40 text-left tracking-widest text-base rounded-lg border px-2 py-1" />
                        <button type="button" id="sendPhoneCode" class="btn btn-outline">获取验证码</button>
                    </div>
                    <div class="text-sm">
                        <label class="inline-flex items-start gap-2">
                            <input type="checkbox" id="agreePhone" class="mt-1 rounded" required>
                            <span>我已阅读并同意 <a href="/agreement.html" class="underline">用户协议</a> 与 <a
                                    href="/privacypolicy.html" class="underline">隐私政策</a></span>
                        </label>
                    </div>
                    <button class="btn btn-primary w-full" type="submit">
                        <i data-lucide="log-in" class="w-4 h-4"></i> 验证并登录
                    </button>
                </form>

                <!-- 邮箱登录 -->
                <form id="form-email" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm mb-1">邮箱</label>
                        <input type="email" name="email" placeholder="name@example.com"
                            class="w-full rounded-xl border px-3 py-2" required>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" name="code" maxlength="10" inputmode="numeric" placeholder="输入验证码"
                            class="w-40 text-left tracking-widest text-base rounded-lg border px-2 py-1" />
                        <button type="button" id="sendEmailCode" class="btn btn-outline">获取验证码</button>
                    </div>
                    <div class="text-sm">
                        <label class="inline-flex items-start gap-2">
                            <input type="checkbox" id="agreeEmail" class="mt-1 rounded" required>
                            <span>我已阅读并同意 <a href="/agreement.html" class="underline">用户协议</a> 与 <a
                                    href="/privacypolicy.html" class="underline">隐私政策</a></span>
                        </label>
                    </div>
                    <button class="btn btn-primary w-full" type="submit">
                        <i data-lucide="log-in" class="w-4 h-4"></i> 验证并登录
                    </button>
                </form>
            </div>
        </section>
    </main>

    <footer class="border-t">
        <div class="mx-auto max-w-6xl px-4 py-8 text-sm text-slate-500">© <span id="year"></span> GoldenAnt</div>
    </footer>

    <script>
        lucide.createIcons();
        document.getElementById('year').textContent = new Date().getFullYear();

        // 创建 Toast 容器
        const toastContainer = document.createElement('div');
        toastContainer.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(toastContainer);

        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-emerald-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-blue-500 text-white',
            };
            const icons = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info',
            };

            const toast = document.createElement('div');
            toast.className = `flex items-center gap-2 px-4 py-2 rounded-xl shadow-lg opacity-0 translate-y-2 transition-all duration-300 ${colors[type]}`;
            toast.innerHTML = `
        <i data-lucide="${icons[type]}" class="w-4 h-4"></i>
        <span>${message}</span>
    `;

            toastContainer.appendChild(toast);
            // ⚠️ 必须在 append 后调用，Lucide 才能渲染出 SVG 图标
            lucide.createIcons();

            // 动画进入
            requestAnimationFrame(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
            });

            // 自动消失
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Tab 切换
        const tabPhone = document.getElementById('tab-phone');
        const tabEmail = document.getElementById('tab-email');
        const formPhone = document.getElementById('form-phone');
        const formEmail = document.getElementById('form-email');
        function setActive(tabBtn) {
            [tabPhone, tabEmail].forEach(b => {
                b.setAttribute('aria-selected', 'false');
                b.classList.remove('bg-emerald-500', 'text-white');
            });
            tabBtn.setAttribute('aria-selected', 'true');
            tabBtn.classList.add('bg-emerald-500', 'text-white');
        }
        function showPhone() {
            formPhone.classList.remove('hidden');
            formEmail.classList.add('hidden');
            setActive(tabPhone);
        }
        function showEmail() {
            formEmail.classList.remove('hidden');
            formPhone.classList.add('hidden');
            setActive(tabEmail);
        }
        tabPhone.addEventListener('click', showPhone);
        tabEmail.addEventListener('click', showEmail);
        showPhone();

        // 邀请码
        const params = new URLSearchParams(window.location.search);
        const inviteId = params.get('inviteId');
        if (inviteId) {
            const box = document.getElementById('invite-box');
            box.textContent = `邀请码：${inviteId}`;
            box.classList.remove('hidden');
        }

        // 倒计时
        function startCountdown(btn) {
            let cd = 60;
            btn.disabled = true;
            btn.textContent = `已发送(${cd}s)`;
            const timer = setInterval(() => {
                cd--;
                btn.textContent = `已发送(${cd}s)`;
                if (cd <= 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> 重新获取';
                    lucide.createIcons();
                }
            }, 1000);
        }

        // 手机验证码
        document.getElementById('sendPhoneCode').addEventListener('click', async () => {
            const phone = formPhone.elements['phone'].value.trim();
            if (!/^1[3-9]\d{9}$/.test(phone)) return showToast('请输入正确手机号', 'error');
            const btn = document.getElementById('sendPhoneCode');
            const oldHtml = btn.innerHTML;
            setLoading(btn, '发送中...');
            try {
                const check = await fetch('https://gdclient.7919.cn/api/Login/checkUserExists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account: phone, type: 1 })
                });
                const checkData = await check.json();
                if (checkData.code == 200 && checkData.data.exists) {
                    showToast('该手机号已注册');
                    resetButton(btn, oldHtml);
                    return
                }
                const res = await fetch('https://gdclient.7919.cn/api/Login/sendCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account: phone, type: 1 })
                });
                const data = await res.json();
                if (data.code == 200) { showToast('验证码已发送', 'success'); startCountdown(btn); }
                else showToast(data.msg || '发送失败', 'error');
            } catch { showToast('网络错误', 'error'); }
        });

        // 邮箱验证码
        document.getElementById('sendEmailCode').addEventListener('click', async () => {
            const email = formEmail.elements['email'].value.trim();
            const reg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!reg.test(email)) return showToast('请输入正确的邮箱地址', 'error');
            const btn = document.getElementById('sendEmailCode');
            const oldHtml = btn.innerHTML;
            setLoading(btn, '发送中...');
            try {
                const check = await fetch('https://gdclient.7919.cn/api/Login/checkUserExists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account: email, type: 2 })
                });
                const checkData = await check.json();
                if (checkData.code == 200 && checkData.data.exists) {
                    showToast('该邮箱已注册');
                    resetButton(btn, oldHtml);
                    return;
                }
                const res = await fetch('https://gdclient.7919.cn/api/Login/sendCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account: email, type: 2 })
                });
                const data = await res.json();
                if (data.code == 200) {
                    showToast('验证码已发送', 'success');
                    startCountdown(btn);
                } else {
                    showToast(data.msg || '发送失败', 'error');
                    resetButton(btn, oldHtml);
                }
            } catch {
                showToast('网络错误', 'error');
                resetButton(btn, oldHtml);
            }
        });

        // 登录
        async function handleLogin(account, type, code) {
            btn.disabled = true;
            const oldHtml = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin w-4 h-4 mr-2 inline" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg> 登录中...`;
            try {
                const res = await fetch('https://gdclient.7919.cn/api/Login/loginOrRegister', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account, type, code, inviterId: inviteId })
                });
                const data = await res.json();
                if (data.code == 200) {
                    showToast('登录成功', 'success');
                    location.href = '/download.html';
                } else {
                    showToast(data.msg || '登录失败', 'error');
                    btn.disabled = false;
                    btn.innerHTML = oldHtml;
                }
            } catch {
                showToast('网络错误', 'error');
                btn.disabled = false;
                btn.innerHTML = oldHtml;
            } finally {
                btn.disabled = false;
                btn.innerHTML = oldHtml;
            }
        }

        formPhone.addEventListener('submit', e => {
            e.preventDefault();
            const phone = formPhone.elements['phone'].value.trim();
            const code = formPhone.elements['code'].value.trim();
            if (!/^\d{4,6}$/.test(code)) return showToast('请输入正确验证码');
            handleLogin(phone, 1, code);
        });

        formEmail.addEventListener('submit', e => {
            e.preventDefault();
            const email = formEmail.elements['email'].value.trim();
            const code = formEmail.elements['code'].value.trim();
            if (!/^\d{4,6}$/.test(code)) return showToast('请输入正确验证码');
            handleLogin(email, 2, code);
        });

        // 通用加载按钮
        function setLoading(btn, text) {
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin w-4 h-4 inline mr-2" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>${text}`;
        }
        function resetButton(btn, html) {
            btn.disabled = false;
            btn.innerHTML = html;
            lucide.createIcons();
        }
    </script>
</body>

</html>